Client A        WS Server 1         Redis        NATS Pub/Sub        WS Server 2        Client B
   |                 |                 |               |                  |                 |
   |--- WebSocket --->|                 |               |                  |                 |
   |                 |--- SET user:123=online -------->|               |                  |
   |                 |                 |               |                  |                 |
   |                 |--- Publish(user:123 online) --->|----------------->|                  |
   |                 |                 |               |--- event ------->|--- notify B --->|
   |                 |                 |               |                  |                 |
   |  <--- pong ---- |                 |               |                  |                 |
   |--- ping ------->|                 |               |                  |                 |
   |                 |                 |               |                  |                 |
... (æŒçºŒé€£ç·š) ...
   |                 |                 |               |                  |                 |
[Client A é—œé–‰é€£ç·š/æ‰ç·š]
   |--- (disconnect)|                 |               |                  |                 |
   |                 |--- SET user:123=offline ------>|               |                  |
   |                 |--- Publish(user:123 offline) ->|----------------->|                  |
   |                 |                 |               |--- event ------->|--- notify B --->|
   |                 |                 |               |                  |                 |


ğŸ”¹ æµç¨‹è§£é‡‹
Client A ä¸Šç·š
èˆ‡ WS Server 1 å»ºç«‹ WebSocketã€‚
Server 1 åœ¨ Redis å¯«å…¥ç‹€æ…‹ = onlineã€‚
åŒæ™‚é€é NATS/Redis PubSub å»£æ’­ "user:123 online"ã€‚
Client B è¨‚é–±åˆ°äº‹ä»¶
Client B é€£åˆ° WS Server 2ã€‚
WS Server 2 æ”¶åˆ° NATS å»£æ’­ â†’ è½‰ç™¼çµ¦ Client B â†’ å³æ™‚é¡¯ç¤º A ä¸Šç·šã€‚
å¿ƒè·³å­˜æ´»
Client A èˆ‡ WS Server 1 å®šæœŸäº¤æ› ping/pongï¼Œç¢ºä¿é€£ç·šæ­£å¸¸ã€‚
è‹¥è¶…æ™‚æœªæ”¶åˆ° pongï¼ŒServer 1 èªå®š Client A æ‰ç·šã€‚
Client A é›¢ç·š
é€£ç·šæ–·é–‹æ™‚ï¼ŒServer 1 æ›´æ–° Redis â†’ user:123=offlineã€‚
å»£æ’­ user:123 offline çµ¦æ‰€æœ‰ WS Serverã€‚
WS Server 2 é€šçŸ¥ Client B â†’ ç«‹åˆ»é¡¯ç¤º A é›¢ç·šã€‚

ğŸ”¹ å¥½è™•
ä½å»¶é²ï¼šNATS/Redis PubSub äº‹ä»¶å‚³æ’­é€šå¸¸åœ¨æ¯«ç§’ç´šã€‚
å¤šå¯¦ä¾‹åŒæ­¥ï¼šç„¡è«– A/B é€£åˆ°å“ªå€‹ WS Serverï¼Œéƒ½èƒ½å³æ™‚çŸ¥é“å°æ–¹ç‹€æ…‹ã€‚
API æŸ¥è©¢ä¸€è‡´æ€§ï¼šå¥½å‹åˆ—è¡¨æŸ¥è©¢æ™‚ç›´æ¥è®€ Redisï¼Œä¸å¿…ä¾è³´ WSã€‚

Redis:
ğŸ”¹ 1. å–®ç”¨æˆ¶ç‹€æ…‹å­˜å„²
ç›®å‰ä½ æ˜¯ online_status:{userId} â†’ stringï¼Œé€™æ¨£å¯ä»¥ï¼Œä½†æœ‰å¹¾å€‹å„ªåŒ–é»ã€‚
å»ºè­°æ”¹æˆ Hash
HSET online_status:{userId} status online since 1695400000 device web
EXPIRE online_status:{userId} {TTL}
ç¯„ä¾‹ï¼š
{
  "status": "online",
  "since": 1695400000,
  "device": "web"
}
å¥½è™•ï¼š
å¯ä»¥å­˜ æ›´å¤šæ¬„ä½ï¼ˆç‹€æ…‹ã€ç™»å…¥æ™‚é–“ã€è£ç½®é¡å‹ï¼‰ã€‚
é¿å…ç‚ºäº†åŠ æ–°æ¬„ä½è€Œé–‹æ–° keyã€‚
ğŸ”¹ 2. å…¨å±€åœ¨ç·šæ¸…å–®
å¦‚æœä½ éœ€è¦å¿«é€ŸæŸ¥ã€Œèª°åœ¨ç·šã€ï¼Œå¯ä»¥ç”¨ Setï¼š
SADD online_users {userId}
SREM online_users {userId}
online_users = ç•¶å‰æ‰€æœ‰åœ¨ç·šç”¨æˆ¶ ID
æŸ¥è©¢æŸäººæ˜¯å¦åœ¨ç·š â†’ SISMEMBER online_users {userId}
æŸ¥è©¢åœ¨ç·šç¸½æ•¸ â†’ SCARD online_users
ğŸ”¹ 3. å¥½å‹ç‹€æ…‹æ‰¹é‡æŸ¥è©¢
å‡è¨­æŸäººæœ‰ 500 å€‹å¥½å‹ï¼Œè¦æŸ¥ä»–å€‘èª°åœ¨ç·šï¼š
æ–¹æ¡ˆ A: Redis pipeline
æ‰¹é‡ HGET online_status:{friendId} status
é©åˆå¥½å‹æ•¸å°‘ï¼ˆ<1kï¼‰çš„æƒ…æ³ã€‚
æ–¹æ¡ˆ B: åˆ©ç”¨ online_users set
SINTER online_users friends:{userId}
friends:{userId} = è©²ç”¨æˆ¶å¥½å‹æ¸…å–® (set)
é€™æ¨£å¯ä»¥ ä¸€æ¬¡å¾—åˆ°æ‰€æœ‰åœ¨ç·šå¥½å‹ã€‚
ğŸ”¹ 4. ç¾¤çµ„åœ¨ç·šæŸ¥è©¢
ç¾¤çµ„å¯èƒ½æœ‰ä¸Šè¬äººï¼Œå¦‚æœè¦é¡¯ç¤ºåœ¨ç·šäººæ•¸ï¼š
SINTERCARD online_users group_members:{groupId}
group_members:{groupId} = è©²ç¾¤çµ„æ‰€æœ‰æˆå“¡ (set)
SINTERCARD å¯ä»¥ç›´æ¥è¿”å›ã€Œäº¤é›†å…ƒç´ æ•¸é‡ã€ï¼Œä¸ç”¨çœŸçš„å–å‡ºæ¸…å–® â†’ O(min(N,M)) è¨ˆç®—ã€‚
é©åˆåšã€Œç¾¤çµ„åœ¨ç·šæ•¸ã€é¡¯ç¤ºã€‚
ğŸ”¹ 5. æœ€å¾Œä¸Šç·šæ™‚é–“ (last seen)
ç•¶ user ä¸‹ç·šæ™‚ï¼Œé™¤äº† status=offlineï¼Œé‚„è¦è¨˜éŒ„ last_seenï¼š
HSET online_status:{userId} status offline last_seen 1695401000
é€™æ¨£å¥½å‹åˆ—è¡¨å¯ä»¥é¡¯ç¤ºï¼š
âœ… åœ¨ç·šä¸­
â³ æœ€å¾Œä¸Šç·šæ™‚é–“ï¼š5 åˆ†é˜å‰
ğŸ”¹ 6. Pub/Sub äº‹ä»¶æ ¼å¼
ç‹€æ…‹è®Šæ›´è¦å»£æ’­ï¼Œå¯ä»¥ç”¨ JSONï¼š
{
  "event": "status_change",
  "userId": "123",
  "status": "offline",
  "timestamp": 1695402000,
  "device": "mobile"
}
é€é NATS / Redis PubSub ç™¼å‡ºå»ï¼Œå…¶ä»– WS server ç›´æ¥è½‰ç™¼çµ¦æœ‰è¨‚é–±çš„ clientã€‚
ğŸ”¹ ç¸½çµ
å–®ç”¨æˆ¶ç‹€æ…‹ï¼šHashï¼Œå­˜ status/device/last_seenã€‚
å…¨å±€åœ¨ç·šï¼šSet online_usersã€‚
å¥½å‹/ç¾¤çµ„æŸ¥è©¢ï¼šåˆ©ç”¨ SINTER / SINTERCARD æé«˜æ•ˆç‡ã€‚
æœ€å¾Œä¸Šç·šæ™‚é–“ï¼šå­˜åˆ° Hashï¼Œæ–¹ä¾¿é¡¯ç¤ºã€‚
ç‹€æ…‹å»£æ’­ï¼šé€é Pub/Subï¼Œç”¨ JSON æ ¼å¼ã€‚
ğŸ‘‰ é€™æ¨£è¨­è¨ˆå¯ä»¥åŒæ™‚æ»¿è¶³ï¼š
å³æ™‚æ€§ï¼ˆWebSocket + Pub/Subï¼‰
æŸ¥è©¢æ•ˆç‡ï¼ˆRedis Set/Hash çµæ§‹ï¼‰
å¯æ“´å±•æ€§ï¼ˆå¥½å‹ã€ç¾¤çµ„ã€è·¨æœå‹™å™¨åŒæ­¥ï¼‰

---------------------------------------
æ–¹æ¡ˆ Aï¼šRESTful API æ”¹å¾ MongoDB è®€å–
æ”¹å‹•é»ï¼šRESTful API æŸ¥è©¢ online status æ™‚ï¼Œä¸åªçœ‹ in-memoryï¼Œè€Œæ˜¯ fallback å» MongoDBã€‚
æµç¨‹ï¼š
REST API å…ˆæŸ¥ in-memory
æ‰¾ä¸åˆ° â†’ æŸ¥ MongoDB
è®€åˆ°ä¹‹å¾Œå¯å†å¯«å› in-memory åšå¿«å–
å„ªé»ï¼šä¸ç”¨æ”¹å¯«å¤ªå¤šé‚è¼¯ï¼Œåªè¦ API handler å¤šåŠ ä¸€å±¤ fallbackã€‚
ç¼ºé»ï¼šMongoDB çš„ I/O é–‹éŠ·å¯èƒ½æ¯”ç´” memory æ…¢ï¼ˆä½†ä½ å¯ä»¥ç”¨ in-memory åšå¿«å–ç·©è§£ï¼‰ã€‚
æ–¹æ¡ˆ Bï¼šå•Ÿå‹•æ™‚é å…ˆè¼‰å…¥ç‹€æ…‹
æ”¹å‹•é»ï¼šæœå‹™é‡å•Ÿæ™‚ï¼Œå¾ MongoDB æŠŠç‹€æ…‹ preload é€² in-memoryã€‚
æµç¨‹ï¼š
ç¨‹å¼å•Ÿå‹•æ™‚ â†’ load MongoDB è£¡çš„æ‰€æœ‰ online ç‹€æ…‹ â†’ å¡å› in-memoryã€‚
å„ªé»ï¼šå•Ÿå‹•å¾Œ RESTful API ç…§èˆŠä½¿ç”¨ in-memoryï¼Œç„¡éœ€æ”¹ handlerã€‚
ç¼ºé»ï¼šè‹¥ç‹€æ…‹æ•¸é‡å¤§ï¼Œå•Ÿå‹•æ™‚é–“æœƒæ‹‰é•·ï¼›è€Œä¸”å¦‚æœ service é•·æ™‚é–“é‹è¡Œï¼Œä¸­é€” MongoDB æ›´æ–°ä½† in-memory æ²’åŒæ­¥ï¼Œå¯èƒ½æœƒæœ‰è½å·®ã€‚
æ–¹æ¡ˆ Cï¼šRESTful API å®Œå…¨åˆ‡æ›åˆ° MongoDB
æ”¹å‹•é»ï¼šRESTful API ç›´æ¥æ”¹è®€ MongoDBï¼Œä¸å†ä¾è³´ in-memoryã€‚
å„ªé»ï¼šç‹€æ…‹å–®ä¸€ä¾†æºï¼Œä¸æœƒæœ‰è½å·®ã€‚
ç¼ºé»ï¼šé€™ç®—æ˜¯ã€Œä¸­åº¦æ”¹å‹•ã€ï¼Œå› ç‚ºè¦èª¿æ•´æ•´å€‹æŸ¥è©¢è·¯å¾‘ã€‚
