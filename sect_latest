db.users.aggregate([
  // Step1: æ¯å€‹ user å±•é–‹ supervisor chain
  {
    $graphLookup: {
      from: "users",
      startWith: "$supervisor",
      connectFromField: "supervisor",
      connectToField: "userId",
      as: "supChain",
      depthField: "level"
    }
  },

  // Step2: æ‰¾å‡ºå››å±¤ä¸»ç®¡ï¼ˆå–æœ€è¿‘çš„ä¸åŒå±¤ä¸»ç®¡ï¼‰
  {
    $addFields: {
      sectSupervisor: {
        $first: {
          $filter: {
            input: "$supChain",
            as: "sup",
            cond: { $ne: ["$$sup.sectId", "$sectId"] }
          }
        }
      },
      deptSupervisor: {
        $first: {
          $filter: {
            input: "$supChain",
            as: "sup",
            cond: { $ne: ["$$sup.deptId", "$deptId"] }
          }
        }
      },
      divisionSupervisor: {
        $first: {
          $filter: {
            input: "$supChain",
            as: "sup",
            cond: { $ne: ["$$sup.divisionId", "$divisionId"] }
          }
        }
      },
      functionSupervisor: {
        $first: {
          $filter: {
            input: "$supChain",
            as: "sup",
            cond: { $ne: ["$$sup.functionId", "$functionId"] }
          }
        }
      }
    }
  },

  // Step3: åªä¿ç•™ userIdï¼Œé¿å…è¼¸å‡ºæ•´å€‹ doc
  {
    $project: {
      sectId: 1,
      deptId: 1,
      divisionId: 1,
      functionId: 1,
      "sectSupervisor.userId": 1,
      "deptSupervisor.userId": 1,
      "divisionSupervisor.userId": 1,
      "functionSupervisor.userId": 1
    }
  },

  // Step4: èšåˆæˆã€Œéƒ¨é–€å ±è¡¨ã€
  {
    $group: {
      _id: {
        sectId: "$sectId",
        deptId: "$deptId",
        divisionId: "$divisionId",
        functionId: "$functionId"
      },
      sectSupervisor: { $addToSet: "$sectSupervisor.userId" },
      deptSupervisor: { $addToSet: "$deptSupervisor.userId" },
      divisionSupervisor: { $addToSet: "$divisionSupervisor.userId" },
      functionSupervisor: { $addToSet: "$functionSupervisor.userId" }
    }
  },

  // Step5: è¼¸å‡ºæ•´é½Šæ ¼å¼
  {
    $project: {
      _id: 0,
      sectId: "$_id.sectId",
      sectSupervisor: 1,
      deptId: "$_id.deptId",
      deptSupervisor: 1,
      divisionId: "$_id.divisionId",
      divisionSupervisor: 1,
      functionId: "$_id.functionId",
      functionSupervisor: 1
    }
  }
])


âœ… æ­£ç¢ºçš„éƒ¨åˆ†
Step1 $graphLookup
ç”¨ startWith: "$supervisor" å»ºå‡ºç›´å±¬ä¸Šç´š â†’ ä¸Šç´šçš„ä¸Šç´š â†’ â€¦ çš„ chainã€‚
as: "supChain" æ”¶åˆ°çš„é™£åˆ—æœƒä¾ç…§ depthField ç”±è¿‘åˆ°é æ’åºï¼ˆlevel:0 æ˜¯ç›´å±¬ä¸Šå¸ï¼‰ã€‚
â†’ é€™è£¡æ˜¯å°çš„ã€‚
Step2 $addFields + $filter
$filter éæ¿¾å‡ºã€Œåœ¨è©²å±¤ç´šå±¬æ€§ä¸åŒçš„ supervisorã€ã€‚
$first æœƒå–åˆ°æœ€è¿‘çš„ç¬¦åˆè€… â†’ å°±æ˜¯ä½ æƒ³è¦çš„ã€Œé‚£ä¸€å±¤ä¸»ç®¡ã€ã€‚
â†’ é€™å€‹é‚è¼¯æ­£ç¢ºã€‚
Step3 $project
é¿å…è¼¸å‡ºæ•´å€‹ supervisor æ–‡ä»¶ï¼Œåªä¿ç•™ userIdã€‚
â†’ åšæ³•æ­£ç¢ºã€‚
Step4 $group
ä»¥éƒ¨é–€ (sectId / deptId / divisionId / functionId) ç‚º keyï¼ŒæŠŠå„ supervisor é›†åˆèµ·ä¾†ã€‚
â†’ é€™æ¨£å¯ä»¥å¾—åˆ°ã€Œè©²éƒ¨é–€çš„ä¸»ç®¡åˆ—è¡¨ã€ã€‚
Step5 $project
è¼¸å‡ºæˆä¹¾æ·¨çš„æ ¼å¼ã€‚
â†’ æ²’å•é¡Œã€‚
âš ï¸ æ½›åœ¨å•é¡Œ / æ”¹é€²å»ºè­°
$filter + $first çš„å®‰å…¨æ€§
å¦‚æœ supChain è£¡æ‰€æœ‰äººçš„ sectId éƒ½ç­‰æ–¼ç•¶å‰ user çš„ sectIdï¼Œ$filter æœƒå›å‚³ç©ºé™£åˆ— â†’ $first æœƒæ˜¯ nullã€‚
é€™åœ¨ã€Œæœ€é«˜ä¸»ç®¡ã€çš„æƒ…å¢ƒæœƒç™¼ç”Ÿã€‚
â†’ å»ºè­°åŠ ä¸Š fallbackï¼ˆä¾‹å¦‚ç”¨ $ifNull å›å‚³ supChain æœ€å¾Œä¸€å€‹ userId ä½œç‚ºæœ€é«˜ä¸»ç®¡ï¼‰ã€‚
ç¯„ä¾‹ä¿®æ”¹ï¼š
sectSupervisor: {
  $let: {
    vars: {
      diff: {
        $filter: {
          input: "$supChain",
          as: "sup",
          cond: { $ne: ["$$sup.sectId", "$sectId"] }
        }
      }
    },
    in: {
      $ifNull: [{ $first: "$$diff" }, { $last: "$supChain" }]
    }
  }
}
$group + $addToSet
é€™è£¡æœƒç”¢ç”Ÿã€Œé™£åˆ—ã€ï¼Œå³ä½¿åªæœ‰ä¸€å€‹ä¸»ç®¡ä¹Ÿæœƒè¼¸å‡ºæˆ ["UA"]ã€‚
å¦‚æœä½ éœ€è¦å–®ä¸€ä¸»ç®¡ï¼ˆè€Œä¸æ˜¯é™£åˆ—ï¼‰ï¼Œè¦æ”¹æˆ $firstï¼ˆå‰ææ˜¯ä¿è­‰å”¯ä¸€ï¼‰ã€‚
ç¯„ä¾‹ï¼š
sectSupervisor: { $first: "$sectSupervisor.userId" },
æ•ˆèƒ½å•é¡Œ
$graphLookup åœ¨å¤§ user collectionï¼ˆå°¤å…¶æ˜¯æ¨¹ç‹€å±¤ç´šæ·±çš„ï¼‰æœƒå¾ˆé‡ã€‚
è‹¥é€™å€‹æŸ¥è©¢è¦é »ç¹è·‘ï¼Œå¯ä»¥è€ƒæ…® é è¨ˆç®— supervisor chain å­˜åœ¨æ–‡ä»¶è£¡ï¼ˆä¾‹å¦‚ allSupervisors: ["UB","UC",...]ï¼‰ï¼ŒæŸ¥è©¢æœƒå¿«å¾ˆå¤šã€‚
ğŸ¯ ç¸½çµ
ä½ çš„ç¨‹å¼åœ¨é‚è¼¯ä¸Šèƒ½æ‰¾å‡ºå„å±¤ä¸»ç®¡ï¼Œæ ¸å¿ƒæ€è·¯æ˜¯æ­£ç¢ºçš„ã€‚
ä¸éè¦æ³¨æ„ï¼š
æœ€é«˜ä¸»ç®¡æœƒè®Šæˆ nullï¼ˆå»ºè­°åŠ  fallbackï¼‰ã€‚
è¼¸å‡º supervisor æœƒæ˜¯é™£åˆ—ï¼ˆæ˜¯å¦è¦æ”¹æˆå–®ä¸€å€¼è¦çœ‹éœ€æ±‚ï¼‰ã€‚
æ•ˆèƒ½ï¼ˆå¦‚æœè³‡æ–™é‡å¤§ï¼Œå»ºè­°æ”¹æˆ denormalization / é å…ˆå¯«å…¥ allSupervisorsï¼‰ã€‚


å‡è¨­ä½ çš„è³‡æ–™å¦‚ä¸‹ï¼ˆç°¡åŒ–ç‰ˆï¼‰ï¼š
[
  { "sectId": "SA", "deptId": "DA", "divisionId": "DDA", "functionId": "FA", "userId": "UA", "supervisor": "UB" },
  { "sectId": "SB", "deptId": "DA", "divisionId": "DDA", "functionId": "FA", "userId": "UZ", "supervisor": "UA" },
  { "sectId": "SB", "deptId": "DA", "divisionId": "DDA", "functionId": "FA", "userId": "UW", "supervisor": "UA" },
  { "sectId": "DA", "deptId": "DA", "divisionId": "DDA", "functionId": "FA", "userId": "UB", "supervisor": "UC" },
  { "sectId": "SC", "deptId": "DB", "divisionId": "DDA", "functionId": "FA", "userId": "UD", "supervisor": "UB" },
  { "sectId": "SC", "deptId": "DB", "divisionId": "DDA", "functionId": "FA", "userId": "UE", "supervisor": "UD" }
]
Step1: $graphLookup å±•é–‹ supervisor chain
Pipelineï¼š
{
  $graphLookup: {
    from: "users",
    startWith: "$supervisor",
    connectFromField: "supervisor",
    connectToField: "userId",
    as: "supChain",
    depthField: "level"
  }
}
è§£é‡‹ï¼š
å°æ¯å€‹ userï¼Œå¾ supervisor é–‹å§‹ï¼Œæ²¿è‘— supervisor â†’ userId èµ°ï¼Œæ‰¾åˆ°æ•´æ¢ä¸Šç´šéˆï¼Œæ”¾åˆ° supChainã€‚
level è¡¨ç¤ºè·é›¢åŸ user çš„å±¤æ•¸ï¼ˆç›´å±¬ä¸»ç®¡ = 0ï¼Œç›´å±¬ä¸»ç®¡çš„ä¸»ç®¡ = 1ï¼Œâ€¦ï¼‰
ç”¢ç”Ÿçš„ä¸­é–“è³‡æ–™ï¼ˆéƒ¨åˆ†ç¤ºä¾‹ï¼‰
user UZ
{
  "sectId": "SB",
  "deptId": "DA",
  "divisionId": "DDA",
  "functionId": "FA",
  "userId": "UZ",
  "supervisor": "UA",
  "supChain": [
    { "userId": "UA", "sectId": "SA", "deptId": "DA", "divisionId": "DDA", "functionId": "FA", "supervisor": "UB", "level": 0 },
    { "userId": "UB", "sectId": "DA", "deptId": "DA", "divisionId": "DDA", "functionId": "FA", "supervisor": "UC", "level": 1 },
    { "userId": "UC", "sectId": "DDA", "deptId": "DB", "divisionId": "DDB", "functionId": "FB", "supervisor": null, "level": 2 }
  ]
}
user UA
{
  "sectId": "SA",
  "deptId": "DA",
  "divisionId": "DDA",
  "functionId": "FA",
  "userId": "UA",
  "supervisor": "UB",
  "supChain": [
    { "userId": "UB", "sectId": "DA", "deptId": "DA", "divisionId": "DDA", "functionId": "FA", "supervisor": "UC", "level": 0 },
    { "userId": "UC", "sectId": "DDA", "deptId": "DB", "divisionId": "DDB", "functionId": "FB", "supervisor": null, "level": 1 }
  ]
}
é€™æ¨£æ¯å€‹ user éƒ½æœƒæœ‰ä¸€å€‹ supChain é™£åˆ—ï¼Œå¾ç›´å±¬ä¸»ç®¡é–‹å§‹å¾€ä¸Šåˆ—åˆ°æœ€é ‚å±¤ã€‚
Step2: $addFields æ‰¾å››å±¤ä¸»ç®¡ï¼ˆå–æœ€è¿‘çš„ä¸åŒå±¤ä¸»ç®¡ï¼‰
Pipelineï¼š
$addFields: {
  sectSupervisor: { $first: { $filter: { input: "$supChain", as: "sup", cond: { $ne: ["$$sup.sectId", "$sectId"] } } } },
  deptSupervisor: { $first: { $filter: { input: "$supChain", as: "sup", cond: { $ne: ["$$sup.deptId", "$deptId"] } } } },
  divisionSupervisor: { $first: { $filter: { input: "$supChain", as: "sup", cond: { $ne: ["$$sup.divisionId", "$divisionId"] } } } },
  functionSupervisor: { $first: { $filter: { input: "$supChain", as: "sup", cond: { $ne: ["$$sup.functionId", "$functionId"] } } } }
}
è§£é‡‹ï¼š
$filter æ‰¾å‡º supChain ä¸­ã€Œè©²å±¬æ€§å€¼å’Œè‡ªå·±ä¸åŒçš„ç¬¬ä¸€å€‹ supervisorã€
$first å–æœ€è¿‘çš„ä¸€å€‹ â†’ å°±æ˜¯æ¯å±¤ä¸»ç®¡
ä¸­é–“è³‡æ–™ç¤ºä¾‹ï¼ˆuser UZï¼‰
{
  "userId": "UZ",
  "sectId": "SB",
  "deptId": "DA",
  "divisionId": "DDA",
  "functionId": "FA",
  "supervisor": "UA",
  "supChain": [ ... å¦‚ä¸Š ... ],
  "sectSupervisor": { "userId": "UA", "sectId": "SA", ... },
  "deptSupervisor": { "userId": "UB", "deptId": "DA", ... },
  "divisionSupervisor": { "userId": "UC", "divisionId": "DDB", ... },
  "functionSupervisor": { "userId": "UC", "functionId": "FB", ... }
}
æ³¨æ„
å¦‚æœæŸä¸€å±¤åœ¨ chain ä¸­æ‰¾ä¸åˆ°ä¸åŒçš„å€¼ï¼Œ$first æœƒå› nullã€‚
é€™è£¡é‚„æ²’æœ‰åš Step3 çš„ $project â†’ userId å·²ç¶“å¯è®€ï¼Œä½†æ•´å€‹ supervisor doc é‚„åœ¨ã€‚
ç¸½çµï¼š
userId	supChain (userIds)	sectSupervisor	deptSupervisor	divisionSupervisor	functionSupervisor
UZ	[UA, UB, UC]	UA	UB	UC	UC
UA	[UB, UC]	UB	UC	UC	UC
UB	[UC]	UC	UC	UC	UC
UD	[UB, UC]	UB	UC	UC	UC
UE	[UD, UB, UC]	UD	UB	UC	UC
é€™å°±æ˜¯ Step1 + Step2 åŸ·è¡Œå®Œçš„ä¸­é–“çµæœã€‚
