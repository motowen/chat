ğŸ“‚ å°ˆæ¡ˆçµæ§‹ç¯„ä¾‹
myapp/
â”œâ”€â”€ client.go        # å®šç¾© interface & production client
â”œâ”€â”€ service.go       # ä½¿ç”¨ client çš„æ¥­å‹™é‚è¼¯
â”œâ”€â”€ service_test.go  # ç”¨ gomock æ¸¬è©¦
â”œâ”€â”€ mocks/           # ç”± mockgen ç”Ÿæˆçš„ mock

client.go

å®šç¾©ä¸€å€‹æŠ½è±¡çš„ HTTPClientï¼Œä¸¦æä¾›å¯¦éš›å¯¦ä½œï¼š

package myapp

import (
	"net/http"
)

type HTTPClient interface {
	Do(req *http.Request) (*http.Response, error)
}

// DefaultClient wraps the real http.Client
type DefaultClient struct {
	client *http.Client
}

func NewDefaultClient() *DefaultClient {
	return &DefaultClient{client: http.DefaultClient}
}

func (c *DefaultClient) Do(req *http.Request) (*http.Response, error) {
	return c.client.Do(req)
}

service.go

å¯«ä¸€å€‹ã€Œå‘¼å«å¤–éƒ¨ APIã€çš„é‚è¼¯ï¼š

package myapp

import (
	"encoding/json"
	"fmt"
	"io"
	"net/http"
)

type Service struct {
	client HTTPClient
	apiURL string
}

func NewService(client HTTPClient, apiURL string) *Service {
	return &Service{client: client, apiURL: apiURL}
}

type APIResponse struct {
	Message string `json:"message"`
}

func (s *Service) FetchMessage() (string, error) {
	req, err := http.NewRequest(http.MethodGet, s.apiURL, nil)
	if err != nil {
		return "", fmt.Errorf("create request: %w", err)
	}

	resp, err := s.client.Do(req)
	if err != nil {
		return "", fmt.Errorf("do request: %w", err)
	}
	defer resp.Body.Close()

	if resp.StatusCode != http.StatusOK {
		return "", fmt.Errorf("unexpected status: %d", resp.StatusCode)
	}

	body, err := io.ReadAll(resp.Body)
	if err != nil {
		return "", fmt.Errorf("read body: %w", err)
	}

	var apiResp APIResponse
	if err := json.Unmarshal(body, &apiResp); err != nil {
		return "", fmt.Errorf("unmarshal: %w", err)
	}

	return apiResp.Message, nil
}

ç”Ÿæˆ gomock

åœ¨ myapp/ åº•ä¸‹åŸ·è¡Œï¼š

mockgen -source=client.go -destination=mocks/mock_client.go -package=mocks


é€™æœƒç”¢ç”Ÿ mocks/mock_client.goï¼Œè£¡é¢æœ‰ MockHTTPClientã€‚

service_test.go

ç”¨ gomock æ¸¬è©¦ï¼š

package myapp_test

import (
	"bytes"
	"io/ioutil"
	"net/http"
	"testing"

	"github.com/golang/mock/gomock"
	"github.com/stretchr/testify/assert"

	"myapp"
	"myapp/mocks"
)

func TestService_FetchMessage(t *testing.T) {
	ctrl := gomock.NewController(t)
	defer ctrl.Finish()

	mockClient := mocks.NewMockHTTPClient(ctrl)

	// æ¨¡æ“¬ API å›æ‡‰
	fakeResp := `{"message": "hello from mock"}`
	httpResp := &http.Response{
		StatusCode: http.StatusOK,
		Body:       ioutil.NopCloser(bytes.NewBufferString(fakeResp)),
	}

	// é æœŸæœƒå‘¼å« Do()
	mockClient.EXPECT().
		Do(gomock.Any()).
		Return(httpResp, nil).
		Times(1)

	svc := myapp.NewService(mockClient, "http://fake.api/test")

	msg, err := svc.FetchMessage()

	assert.NoError(t, err)
	assert.Equal(t, "hello from mock", msg)
}

ğŸ”‘ é‡é»

æŠ½è±¡å‡º interface (HTTPClient)
â†’ æ¸¬è©¦æ™‚ç”¨ mockï¼Œproduction æ™‚ç”¨ http.Clientã€‚

gomock é©—è­‰å‘¼å«æ¬¡æ•¸èˆ‡åƒæ•¸
â†’ å¯ä»¥ä¿è­‰ç¨‹å¼çœŸçš„æœ‰å‘¼å«å¤–éƒ¨ APIã€‚

æ¸¬è©¦æ™‚ä¸æ‰“çœŸ API
â†’ æ¸¬è©¦å¿«é€Ÿåˆ deterministicã€‚
